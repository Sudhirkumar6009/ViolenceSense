<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ViolenceSense - Live Stream Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              dark: {
                900: "#0a0a0f",
                800: "#12121a",
                700: "#1a1a24",
                600: "#24242e",
              },
            },
          },
        },
      };
    </script>
    <style>
      body {
        background-color: #0a0a0f;
      }
      .glass-card {
        background: rgba(255, 255, 255, 0.02);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.05);
      }
      .alert-pulse {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }
    </style>
  </head>
  <body class="dark text-white min-h-screen">
    <div id="app" class="container mx-auto px-4 py-8">
      <!-- Header -->
      <header class="flex items-center justify-between mb-8">
        <div>
          <h1
            class="text-3xl font-bold bg-gradient-to-r from-purple-500 to-pink-500 bg-clip-text text-transparent"
          >
            ViolenceSense Live
          </h1>
          <p class="text-gray-400 mt-1">Real-time RTSP Stream Monitoring</p>
        </div>
        <div class="flex items-center gap-4">
          <div
            id="connection-status"
            class="flex items-center gap-2 px-4 py-2 rounded-full bg-dark-700"
          >
            <div
              id="ws-indicator"
              class="w-3 h-3 rounded-full bg-gray-500"
            ></div>
          </div>
        </div>
      </header>

      <!-- Stats Bar -->
      <div class="grid grid-cols-4 gap-4 mb-8">
        <div class="glass-card rounded-xl p-4">
          <div class="text-gray-400 text-sm">Active Streams</div>
          <div id="stat-streams" class="text-2xl font-bold text-white">0</div>
        </div>
        <div class="glass-card rounded-xl p-4">
          <div class="text-gray-400 text-sm">Pending Alerts</div>
          <div id="stat-pending" class="text-2xl font-bold text-yellow-500">
            0
          </div>
        </div>
        <div class="glass-card rounded-xl p-4">
          <div class="text-gray-400 text-sm">Confirmed Today</div>
          <div id="stat-confirmed" class="text-2xl font-bold text-red-500">
            0
          </div>
        </div>
        <div class="glass-card rounded-xl p-4">
          <div class="text-gray-400 text-sm">Dismissed Today</div>
          <div id="stat-dismissed" class="text-2xl font-bold text-green-500">
            0
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="grid grid-cols-3 gap-6">
        <!-- Streams Panel -->
        <div class="col-span-1">
          <div class="glass-card rounded-2xl p-6">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-xl font-semibold">Streams</h2>
              <button
                onclick="showAddStreamModal()"
                class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-sm"
              >
                + Add Stream
              </button>
            </div>
            <div id="streams-list" class="space-y-3">
              <div class="text-gray-500 text-center py-8">
                No streams configured
              </div>
            </div>
          </div>
        </div>

        <!-- Live Scores Panel -->
        <div class="col-span-1">
          <div class="glass-card rounded-2xl p-6">
            <h2 class="text-xl font-semibold mb-4">Live Inference</h2>
            <div id="live-scores" class="space-y-4">
              <div class="text-gray-500 text-center py-8">
                No active inference
              </div>
            </div>
          </div>
        </div>

        <!-- Alerts Panel -->
        <div class="col-span-1">
          <div class="glass-card rounded-2xl p-6">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-xl font-semibold">Pending Alerts</h2>
              <span
                id="alert-badge"
                class="hidden px-2 py-1 bg-red-600 rounded-full text-xs alert-pulse"
              >
                New
              </span>
            </div>
            <div id="alerts-list" class="space-y-3 max-h-96 overflow-y-auto">
              <div class="text-gray-500 text-center py-8">
                No pending alerts
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Events History -->
      <div class="mt-8">
        <div class="glass-card rounded-2xl p-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-semibold">Event History</h2>
            <select
              id="event-filter"
              onchange="loadEvents()"
              class="bg-dark-700 rounded-lg px-4 py-2 text-sm"
            >
              <option value="">All Status</option>
              <option value="pending">Pending</option>
              <option value="confirmed">Confirmed</option>
              <option value="dismissed">Dismissed</option>
            </select>
          </div>
          <div id="events-table" class="overflow-x-auto">
            <table class="w-full text-left">
              <thead>
                <tr class="text-gray-400 text-sm border-b border-dark-600">
                  <th class="pb-3">Stream</th>
                  <th class="pb-3">Time</th>
                  <th class="pb-3">Duration</th>
                  <th class="pb-3">Confidence</th>
                  <th class="pb-3">Severity</th>
                  <th class="pb-3">Status</th>
                  <th class="pb-3">Actions</th>
                </tr>
              </thead>
              <tbody id="events-body">
                <tr>
                  <td colspan="7" class="text-center py-8 text-gray-500">
                    Loading...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Stream Modal -->
    <div
      id="add-stream-modal"
      class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50"
    >
      <div class="glass-card rounded-2xl p-8 w-full max-w-md">
        <h3 class="text-xl font-semibold mb-6">Add New Stream</h3>
        <form onsubmit="addStream(event)">
          <div class="space-y-4">
            <div>
              <label class="block text-sm text-gray-400 mb-1"
                >Stream Name</label
              >
              <input
                type="text"
                id="stream-name"
                required
                class="w-full bg-dark-700 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
              />
            </div>
            <div>
              <label class="block text-sm text-gray-400 mb-1">Stream URL</label>
              <input
                type="text"
                id="stream-url"
                required
                placeholder="rtsp://..."
                class="w-full bg-dark-700 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
              />
            </div>
            <div>
              <label class="block text-sm text-gray-400 mb-1"
                >Stream Type</label
              >
              <select
                id="stream-type"
                class="w-full bg-dark-700 rounded-lg px-4 py-2 text-white"
              >
                <option value="rtsp">RTSP</option>
                <option value="rtmp">RTMP</option>
                <option value="webcam">Webcam</option>
                <option value="file">File</option>
              </select>
            </div>
            <div>
              <label class="block text-sm text-gray-400 mb-1"
                >Location (Optional)</label
              >
              <input
                type="text"
                id="stream-location"
                placeholder="e.g., Front Entrance"
                class="w-full bg-dark-700 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
              />
            </div>
            <div class="flex items-center gap-2">
              <input
                type="checkbox"
                id="stream-autostart"
                checked
                class="rounded"
              />
              <label for="stream-autostart" class="text-sm text-gray-400"
                >Auto-start stream</label
              >
            </div>
          </div>
          <div class="flex gap-4 mt-6">
            <button
              type="button"
              onclick="hideAddStreamModal()"
              class="flex-1 px-4 py-2 bg-dark-600 rounded-lg hover:bg-dark-500"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="flex-1 px-4 py-2 bg-purple-600 rounded-lg hover:bg-purple-700"
            >
              Add Stream
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Clip Review Modal -->
    <div
      id="clip-modal"
      class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50"
    >
      <div class="glass-card rounded-2xl p-6 w-full max-w-3xl">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-semibold">Review Event</h3>
          <button
            onclick="hideClipModal()"
            class="text-gray-400 hover:text-white"
          >
            &times;
          </button>
        </div>
        <div id="clip-content">
          <video
            id="clip-video"
            controls
            class="w-full rounded-lg mb-4 bg-black"
          ></video>
          <div id="clip-info" class="mb-4"></div>
          <div class="flex gap-4">
            <button
              onclick="confirmEvent()"
              class="flex-1 px-4 py-3 bg-red-600 hover:bg-red-700 rounded-lg font-semibold"
            >
              ⚠️ Confirm Violence
            </button>
            <button
              onclick="dismissEvent()"
              class="flex-1 px-4 py-3 bg-green-600 hover:bg-green-700 rounded-lg font-semibold"
            >
              ✓ Dismiss (False Positive)
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      const API_BASE = "http://localhost:8080/api/v1";
      let ws = null;
      let currentEventId = null;
      let liveScores = {};

      // WebSocket connection
      function connectWebSocket() {
        ws = new WebSocket("ws://localhost:8080/api/v1/ws");

        ws.onopen = () => {
          document.getElementById("ws-indicator").className =
            "w-3 h-3 rounded-full bg-green-500";
          document.getElementById("ws-status").textContent = "Connected";
        };

        ws.onclose = () => {
          document.getElementById("ws-indicator").className =
            "w-3 h-3 rounded-full bg-red-500";
          document.getElementById("ws-status").textContent = "Disconnected";
          setTimeout(connectWebSocket, 3000);
        };

        ws.onmessage = (event) => {
          const data = JSON.parse(event.data);
          handleWebSocketMessage(data);
        };
      }

      function handleWebSocketMessage(data) {
        switch (data.type) {
          case "inference_result":
            updateLiveScore(data);
            break;
          case "event_start":
            showEventAlert(data);
            loadPendingAlerts();
            break;
          case "event_end":
            loadPendingAlerts();
            loadEvents();
            break;
          case "stream_status":
            loadStreams();
            break;
        }
      }

      function updateLiveScore(data) {
        liveScores[data.stream_id] = data;
        renderLiveScores();
      }

      function renderLiveScores() {
        const container = document.getElementById("live-scores");
        const scores = Object.values(liveScores);

        if (scores.length === 0) {
          container.innerHTML =
            '<div class="text-gray-500 text-center py-8">No active inference</div>';
          return;
        }

        container.innerHTML = scores
          .map(
            (s) => `
                <div class="bg-dark-700 rounded-xl p-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm text-gray-400">Stream ${s.stream_id}</span>
                        <span class="text-xs ${s.is_violent ? "text-red-400" : "text-green-400"}">
                            ${s.is_violent ? "⚠️ VIOLENCE" : "✓ Safe"}
                        </span>
                    </div>
                    <div class="relative h-4 bg-dark-600 rounded-full overflow-hidden">
                        <div class="absolute inset-0 bg-gradient-to-r from-green-500 via-yellow-500 to-red-500 opacity-20"></div>
                        <div class="h-full ${s.is_violent ? "bg-red-500" : "bg-green-500"} transition-all duration-300"
                             style="width: ${s.violence_score * 100}%"></div>
                    </div>
                    <div class="flex justify-between mt-1 text-xs text-gray-500">
                        <span>Violence: ${(s.violence_score * 100).toFixed(1)}%</span>
                        <span>Safe: ${(s.non_violence_score * 100).toFixed(1)}%</span>
                    </div>
                </div>
            `,
          )
          .join("");
      }

      function showEventAlert(data) {
        document.getElementById("alert-badge").classList.remove("hidden");
        // Play alert sound if desired
      }

      // API calls
      async function loadStreams() {
        try {
          const res = await fetch(`${API_BASE}/streams`);
          const data = await res.json();
          renderStreams(data.data || []);
          document.getElementById("stat-streams").textContent =
            data.data?.length || 0;
        } catch (e) {
          console.error("Failed to load streams:", e);
        }
      }

      function renderStreams(streams) {
        const container = document.getElementById("streams-list");

        if (streams.length === 0) {
          container.innerHTML =
            '<div class="text-gray-500 text-center py-8">No streams configured</div>';
          return;
        }

        container.innerHTML = streams
          .map(
            (s) => `
                <div class="bg-dark-700 rounded-xl p-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="font-medium">${s.name}</span>
                        <span class="flex items-center gap-1 text-xs ${s.is_connected ? "text-green-400" : "text-gray-500"}">
                            <span class="w-2 h-2 rounded-full ${s.is_connected ? "bg-green-400" : "bg-gray-500"}"></span>
                            ${s.is_connected ? "Live" : "Offline"}
                        </span>
                    </div>
                    <div class="text-xs text-gray-500 truncate mb-2">${s.url}</div>
                    <div class="flex gap-2">
                        ${
                          s.is_running
                            ? `<button onclick="stopStream(${s.id})" class="flex-1 px-3 py-1 bg-red-600/20 text-red-400 rounded text-xs">Stop</button>`
                            : `<button onclick="startStream(${s.id})" class="flex-1 px-3 py-1 bg-green-600/20 text-green-400 rounded text-xs">Start</button>`
                        }
                        <button onclick="deleteStream(${s.id})" class="px-3 py-1 bg-dark-600 rounded text-xs text-gray-400">Delete</button>
                    </div>
                </div>
            `,
          )
          .join("");
      }

      async function loadPendingAlerts() {
        try {
          const res = await fetch(`${API_BASE}/events/pending`);
          const data = await res.json();
          renderAlerts(data.data || []);
          document.getElementById("stat-pending").textContent = data.count || 0;
        } catch (e) {
          console.error("Failed to load alerts:", e);
        }
      }

      function renderAlerts(alerts) {
        const container = document.getElementById("alerts-list");

        if (alerts.length === 0) {
          container.innerHTML =
            '<div class="text-gray-500 text-center py-8">No pending alerts</div>';
          document.getElementById("alert-badge").classList.add("hidden");
          return;
        }

        container.innerHTML = alerts
          .map(
            (a) => `
                <div class="bg-dark-700 rounded-xl p-4 border-l-4 border-red-500 cursor-pointer hover:bg-dark-600"
                     onclick="reviewEvent(${a.id}, '${a.clip_path || ""}')">
                    <div class="flex items-center justify-between mb-2">
                        <span class="font-medium text-red-400">${a.stream_name}</span>
                        <span class="text-xs px-2 py-1 rounded-full ${getSeverityClass(a.severity)}">${a.severity}</span>
                    </div>
                    <div class="text-xs text-gray-500">
                        ${new Date(a.start_time).toLocaleString()}
                    </div>
                    <div class="text-sm mt-1">
                        Confidence: <span class="text-red-400">${(a.max_confidence * 100).toFixed(1)}%</span>
                    </div>
                </div>
            `,
          )
          .join("");
      }

      async function loadEvents() {
        try {
          const filter = document.getElementById("event-filter").value;
          const url = filter
            ? `${API_BASE}/events?status=${filter}`
            : `${API_BASE}/events`;
          const res = await fetch(url);
          const data = await res.json();
          renderEventsTable(data.data || []);
        } catch (e) {
          console.error("Failed to load events:", e);
        }
      }

      function renderEventsTable(events) {
        const tbody = document.getElementById("events-body");

        if (events.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="7" class="text-center py-8 text-gray-500">No events found</td></tr>';
          return;
        }

        tbody.innerHTML = events
          .map(
            (e) => `
                <tr class="border-b border-dark-600 hover:bg-dark-700">
                    <td class="py-3">${e.stream_name}</td>
                    <td class="py-3 text-gray-400">${new Date(e.start_time).toLocaleString()}</td>
                    <td class="py-3">${e.duration_seconds?.toFixed(1) || "-"}s</td>
                    <td class="py-3">
                        <span class="text-red-400">${(e.max_confidence * 100).toFixed(1)}%</span>
                    </td>
                    <td class="py-3">
                        <span class="text-xs px-2 py-1 rounded-full ${getSeverityClass(e.severity)}">${e.severity}</span>
                    </td>
                    <td class="py-3">
                        <span class="text-xs px-2 py-1 rounded-full ${getStatusClass(e.status)}">${e.status}</span>
                    </td>
                    <td class="py-3">
                        ${
                          e.clip_path
                            ? `<button onclick="reviewEvent(${e.id}, '${e.clip_path}')" class="text-purple-400 hover:text-purple-300 text-sm">Review</button>`
                            : "-"
                        }
                    </td>
                </tr>
            `,
          )
          .join("");
      }

      function getSeverityClass(severity) {
        switch (severity) {
          case "critical":
            return "bg-red-600/30 text-red-400";
          case "high":
            return "bg-orange-600/30 text-orange-400";
          case "medium":
            return "bg-yellow-600/30 text-yellow-400";
          default:
            return "bg-gray-600/30 text-gray-400";
        }
      }

      function getStatusClass(status) {
        switch (status) {
          case "confirmed":
            return "bg-red-600/30 text-red-400";
          case "dismissed":
            return "bg-green-600/30 text-green-400";
          case "pending":
            return "bg-yellow-600/30 text-yellow-400";
          default:
            return "bg-gray-600/30 text-gray-400";
        }
      }

      // Stream actions
      async function addStream(event) {
        event.preventDefault();

        const data = {
          name: document.getElementById("stream-name").value,
          url: document.getElementById("stream-url").value,
          stream_type: document.getElementById("stream-type").value,
          location: document.getElementById("stream-location").value || null,
          auto_start: document.getElementById("stream-autostart").checked,
        };

        try {
          const res = await fetch(`${API_BASE}/streams`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });
          const result = await res.json();
          if (result.success) {
            hideAddStreamModal();
            loadStreams();
          } else {
            alert("Failed to add stream: " + result.error);
          }
        } catch (e) {
          alert("Failed to add stream: " + e.message);
        }
      }

      async function startStream(id) {
        await fetch(`${API_BASE}/streams/${id}/start`, { method: "POST" });
        loadStreams();
      }

      async function stopStream(id) {
        await fetch(`${API_BASE}/streams/${id}/stop`, { method: "POST" });
        loadStreams();
      }

      async function deleteStream(id) {
        if (confirm("Are you sure you want to delete this stream?")) {
          await fetch(`${API_BASE}/streams/${id}`, { method: "DELETE" });
          loadStreams();
        }
      }

      // Event review
      function reviewEvent(id, clipPath) {
        currentEventId = id;
        const video = document.getElementById("clip-video");

        if (clipPath) {
          // Extract filename from path
          const filename = clipPath.split("/").pop().split("\\").pop();
          video.src = `${API_BASE}/clips/${filename}`;
        }

        document.getElementById("clip-modal").classList.remove("hidden");
      }

      async function confirmEvent() {
        if (!currentEventId) return;

        await fetch(`${API_BASE}/events/${currentEventId}/confirm`, {
          method: "POST",
        });
        hideClipModal();
        loadPendingAlerts();
        loadEvents();
      }

      async function dismissEvent() {
        if (!currentEventId) return;

        await fetch(`${API_BASE}/events/${currentEventId}/dismiss`, {
          method: "POST",
        });
        hideClipModal();
        loadPendingAlerts();
        loadEvents();
      }

      // Modal controls
      function showAddStreamModal() {
        document.getElementById("add-stream-modal").classList.remove("hidden");
      }

      function hideAddStreamModal() {
        document.getElementById("add-stream-modal").classList.add("hidden");
      }

      function hideClipModal() {
        document.getElementById("clip-modal").classList.add("hidden");
        document.getElementById("clip-video").src = "";
        currentEventId = null;
      }

      // Initialize
      document.addEventListener("DOMContentLoaded", () => {
        connectWebSocket();
        loadStreams();
        loadPendingAlerts();
        loadEvents();

        // Refresh periodically
        setInterval(loadStreams, 10000);
        setInterval(loadPendingAlerts, 5000);
      });
    </script>
  </body>
</html>
